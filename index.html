<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tiokompisar!</title>
  <style>
    :root{
      --bg1:#e76699; --bg2:#9e56f9;
      --accent1:#ffd84f; --accent2:#ffb300;
      --text-dark:#5a3b00;
      --correct:#32c48d; --wrong:#ff5252;
    }

    body {
      margin:0;
      font-family:"Comic Sans MS", sans-serif;
      text-align:center;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:white;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      overflow:hidden;
    }

    /* ---------- INTRO ---------- */
    #startScreen {
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      justify-content:space-between; align-items:center;
      padding:30px 20px;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      z-index:10;
    }

    .arcTitle {
      font-size:clamp(2rem,6vw,3em);
      font-weight:bold; color:white;
      text-transform:uppercase;
      text-shadow:
        -2px -2px 0 #e642a6,
         2px -2px 0 #e642a6,
        -2px  2px 0 #e642a6,
         2px  2px 0 #e642a6,
         3px  3px 6px rgba(0,0,0,0.6);
      transform:rotate(-4deg);
      letter-spacing:4px;
      margin:20px 0;
    }

    /* Magic animation for intro: pulse the girl and create sparks */
    .intro-magic {
      animation: introPulse 1.1s ease-out both;
    }
    @keyframes introPulse {
      0% { transform: scale(1) translateY(0); filter: drop-shadow(0 6px 6px rgba(0,0,0,0.25)); }
      40% { transform: scale(1.06) translateY(-6px); filter: drop-shadow(0 12px 12px rgba(0,0,0,0.35)); }
      100% { transform: scale(1) translateY(0); filter: drop-shadow(0 6px 6px rgba(0,0,0,0.25)); }
    }

    .spark {
      position: absolute;
      width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff 0%, rgba(255,255,255,0.9) 30%, rgba(255,200,255,0.2) 70%, transparent 100%);
      pointer-events: none; opacity: 0;
      transform: translateY(0) scale(0.6);
      animation: sparkUp 900ms cubic-bezier(.2,.9,.3,1) forwards;
    }
    @keyframes sparkUp {
      0% { opacity: 1; transform: translateY(0) scale(0.6); }
      60% { opacity: 1; transform: translateY(-60px) scale(1.05); }
      100% { opacity: 0; transform: translateY(-110px) scale(1.4); }
    }
    /* Intro-bild: se till att den beh√•ller proportioner och inte str√§cks */
    #introGirl {
      max-width: 450px;
      width: min(90%, 450px);
      height: auto;
      display: block;
      object-fit: contain;
    }

    /* Celebrate image: base size like intro, then scale up when visible */
    #girlGameCelebrate {
      max-width: 450px;
      width: min(90%, 450px);
      height: auto;
      display: none; /* controlled by JS */
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(1);
      z-index: 9999;
      pointer-events: auto; /* allow click to dismiss */
      transition: transform 260ms ease, opacity 200ms ease;
    }
    /* when we want it big and prominent */
    #girlGameCelebrate.celebrate-visible {
      transform: translate(-50%, -50%) scale(1.6);
      max-width: 900px;
      width: min(90%, 900px);
      opacity: 1;
      /* add a small bounce to make the celebration feel lively */
      transform-origin: 50% 50%;
      animation: celebrateBounce 640ms cubic-bezier(.22,.9,.3,1) both;
    }

    #description {
      font-size:1.05rem; line-height:1.5rem;
      max-width:420px; margin:20px 0;
      color:rgba(255,255,255,0.95);
    }

    #startButton {
      background:linear-gradient(180deg,var(--accent1),var(--accent2));
      border:none; border-radius:40px;
      padding:18px 50px; font-size:1.1rem;
      font-weight:bold; color:var(--text-dark);
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,0.25);
      margin-bottom:30px;
      transition:transform 0.15s ease;
    }
    #startButton:active{transform:translateY(2px);}

    /* Dekorationsstj√§rnor */
    .star { position:absolute; opacity:.9; pointer-events:none; }
    .star1{ top:80px; left:6%; }
    .star2{ top:60px; right:18%; }
    .star3{ bottom:120px; left:22%; }
    .star4{ bottom:200px; right:12%; }

    /* ---------- SPELVY ---------- */
  #girlGame, #girlGameFalse, #girlGameGood, #girlGameCelebrate {width:min(250px,50%);margin-top:10px;display:none;}
    #title {font-size:clamp(2.4rem,4vw,2rem);margin:20px 0;display:none;}
    #question {font-size:clamp(2.1rem,3vw,1.8rem);margin:20px 10px;min-height:2.2em;}

    .buttons {
      display:grid;
      grid-template-columns:repeat(2,minmax(120px,1fr));
      gap:12px; justify-content:center;
      margin-top:10px; width:min(320px,90%);
    }
    button.answer {
      background:linear-gradient(180deg,var(--accent1),var(--accent2));
      border:none; border-radius:20px;
      padding:14px; font-size:1.2rem;
      font-weight:bold; color:var(--text-dark);
      cursor:pointer;
      box-shadow:0 6px 12px rgba(0,0,0,0.2);
      transition:transform .12s ease,opacity .12s, background 0.2s;
      user-select:none;
    }
    button.answer:active{transform:translateY(2px);}
    button.answer:disabled{opacity:.6;cursor:default;}

    /* Feedback + animation */
    #feedback {
      margin-top:18px;
      font-size:1.8rem;
      min-height:1.6em;
      color:rgba(255,255,255,0.95);
      transition:opacity 0.3s ease;
    }

    button.answer.correct {
      background:#32c48d; color:white;
      transform:scale(1.1);
    }
    button.answer.wrong {
      background:#ff5252; color:white;
      animation:blink 0.4s ease;
    }
    @keyframes blink {
      0%,100% {opacity:1;}
      50% {opacity:0.4;}
    }

    /* R√§knare */
    #counter {
      position:absolute; bottom:10px;
      font-size:1rem; color:rgba(255,255,255,0.9);
    }

    /* Stj√§rnor vid vinst */
    .star-fall {
      position:absolute; font-size:1.6rem; opacity:0;
      animation:fall 3s linear forwards;
      z-index:20; pointer-events:none;
      transform:translateY(-40px);
    }
    @keyframes fall {
      0%{transform:translateY(-40px) scale(1);opacity:1;}
      80%{opacity:1;}
      100%{transform:translateY(100vh) scale(0.5);opacity:0;}
    }
    @keyframes celebrateBounce {
      0% { transform: translate(-50%, -50%) scale(0.8); }
      55% { transform: translate(-50%, -50%) scale(1.75); }
      80% { transform: translate(-50%, -50%) scale(1.45); }
      100% { transform: translate(-50%, -50%) scale(1.6); }
    }
  </style>
</head>
<body>
  <!-- ---------- INTRO ---------- -->
  <div id="startScreen">
    <div class="star star1">‚≠ê</div>
    <div class="star star2">‚≠ê</div>
    <div class="star star3">‚≠ê</div>
    <div class="star star4">‚≠ê</div>

    <h1 class="arcTitle">Tiokompisar</h1>

    <img id="introGirl" src="Ui_girl_transparent.png" alt="Flickan">
    <div id="description">
      Hon √§lskar att r√§kna och vill hj√§lpa dig att hitta alla tiokompisar.  
      N√§r du lyckas blir hon superglad och hejar p√• dig!
    </div>
    <button id="startButton">Spela nu</button>
  </div>

  <!-- ---------- SPELVY ---------- -->
  <img id="girlGame" src="Ui_girl_transparent.png" alt="" aria-hidden="true">
  <!-- Bild som visas vid fel svar; f√∂rladdas och h√•lls g√∂md tills beh√∂vs -->
  <img id="girlGameFalse" src="Ui_girl_false.png" alt="" aria-hidden="true">
  <!-- Bild som visas vid r√§tt svar (good) -->
  <img id="girlGameGood" src="Ui_girl_good.png" alt="" aria-hidden="true">
  <!-- Bild som visas n√§r spelet √§r avslutat (celebrate) -->
  <img id="girlGameCelebrate" src="Ui_girl_celebrate.png" alt="" aria-hidden="true">
  <h1 id="title">Tiokompisar üíõ</h1>

  <div id="question"></div>
  <div class="buttons" id="buttons"></div>
  <div id="feedback" aria-live="polite"></div>
  <div id="counter" aria-live="polite"></div>

  <!-- Ljudfiler (l√§gg i samma mapp som HTML). Anv√§nd correct.wav f√∂r r√§tt celebrate.wav vid slut, fel.wav f√∂r fel. -->
  <audio id="soundCorrect" preload="auto">
    <source src="correct.wav" type="audio/wav">
    <!-- fallback text -->
  </audio>
  <audio id="soundWrong" preload="auto">
    <source src="fel.wav" type="audio/wav">
    <!-- fallback text -->
  </audio>
  <audio id="soundApplause" preload="auto">
    <source src="celebrate.wav" type="audio/wav">
    <!-- fallback text -->
  </audio>
  <!-- ljud f√∂r startknapp: magic.wav spelas ENDAST vid start -->
  <audio id="soundMagic" preload="auto">
    <source src="magic.wav" type="audio/wav">
  </audio>

  <script>
    const tidForNastaFraga = 1400;
    const maxPoang = 5;

  const startScreen = document.getElementById("startScreen");
  const startButton = document.getElementById("startButton");
  const soundMagic = document.getElementById("soundMagic");
  const girlGame = document.getElementById("girlGame");
  const girlGameFalse = document.getElementById("girlGameFalse");
  const girlGameGood = document.getElementById("girlGameGood");
  const girlGameCelebrate = document.getElementById("girlGameCelebrate");
    const titleEl = document.getElementById("title");
    const questionEl = document.getElementById("question");
    const buttonsEl = document.getElementById("buttons");
    const feedbackEl = document.getElementById("feedback");
    const counterEl = document.getElementById("counter");

    const soundCorrect = document.getElementById("soundCorrect");
    const soundWrong = document.getElementById("soundWrong");
    const soundApplause = document.getElementById("soundApplause");

    // Default volumes
    soundCorrect.volume = 0.5;
    soundWrong.volume = 0.6;
    soundApplause.volume = 1.0;

    // Shared AudioContext for reliable fallback tones and to satisfy autoplay policy
    let audioCtx = null;
    let audioPrimed = false;
    function primeAudio() {
      if (audioPrimed) return;
      audioPrimed = true;
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        // resume context in case it's suspended
        if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
      } catch(e){ audioCtx = null; }
      // f√∂rs√∂k att spela och pausa snabbt f√∂r att f√• till√•telse p√• audio element
      [soundCorrect, soundWrong, soundApplause].forEach(s => {
        try { const p = s.play(); if (p && p.then) p.then(()=>s.pause()).catch(()=>{}); } catch(e){}
      });
    }

  let score = 0;
    let accepting = true;

    // Play a sound element, with promise handling and WebAudio fallback
    function playSound(sound) {
      if (!audioPrimed) primeAudio();
      try {
        sound.currentTime = 0;
        const p = sound.play();
        if (p && typeof p.then === 'function') {
          p.catch(() => {
            // om element.play avvisas, spela fallback via WebAudio
            playFallbackTone(sound === soundWrong ? 'wrong' : 'celebrate');
          });
        }
      } catch (e) {
        // synkron fel -> fallback
        playFallbackTone(sound === soundWrong ? 'wrong' : 'celebrate');
      }
    }

    function playFallbackTone(kind) {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioCtx.currentTime;
        const gain = audioCtx.createGain();
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(0, now);

        if (kind === 'wrong') {
          // ett kort dystert 'buzz'
          const osc = audioCtx.createOscillator();
          osc.type = 'sawtooth'; osc.frequency.setValueAtTime(220, now);
          osc.connect(gain);
          osc.start(now);
          osc.stop(now + 0.18);
          gain.gain.linearRampToValueAtTime(0.18, now + 0.01);
          gain.gain.linearRampToValueAtTime(0.0001, now + 0.22);
        } else {
          // celebrate: tv√• mjuka toner
          const freqs = [880, 1100];
          freqs.forEach((f, i) => {
            const o = audioCtx.createOscillator();
            o.type = 'sine'; o.frequency.setValueAtTime(f, now + i * 0.07);
            o.connect(gain);
            o.start(now + i * 0.07);
            o.stop(now + i * 0.07 + 0.18);
          });
          gain.gain.linearRampToValueAtTime(0.12, now + 0.02);
          gain.gain.linearRampToValueAtTime(0.0001, now + 0.45);
        }
      } catch (e) {
        // ge upp tyst
      }
    }

    function updateCounter() {
      counterEl.textContent = `üìä Fr√•ga ${score+1} av ${maxPoang}`;
    }

    function showNormalGirl() {
      girlGameFalse.style.display = 'none';
      girlGameGood.style.display = 'none';
      girlGameCelebrate.style.display = 'none';
      girlGame.style.display = 'block';
    }
    function showFalseGirl() {
      girlGame.style.display = 'none';
      girlGameGood.style.display = 'none';
      girlGameCelebrate.style.display = 'none';
      girlGameFalse.style.display = 'block';
    }
    function showGoodGirl() {
      girlGame.style.display = 'none';
      girlGameFalse.style.display = 'none';
      girlGameCelebrate.style.display = 'none';
      girlGameGood.style.display = 'block';
    }
    function showCelebrateGirl() {
      girlGame.style.display = 'none';
      girlGameFalse.style.display = 'none';
      girlGameGood.style.display = 'none';
      girlGameCelebrate.style.display = 'block';
      // add class to make it scale up and sit above text
      girlGameCelebrate.classList.add('celebrate-visible');
    }

    function spawnSparks(count, anchorEl) {
      const rect = anchorEl ? anchorEl.getBoundingClientRect() : {left: window.innerWidth/2, top: 200, width: 100, height:100};
      for (let i=0;i<count;i++){
        const s = document.createElement('div');
        s.className = 'spark';
        // random position around the anchor
        const x = rect.left + rect.width * (0.2 + Math.random()*0.6);
        const y = rect.top + rect.height * (0.2 + Math.random()*0.6);
        s.style.left = x + 'px';
        s.style.top = y + 'px';
        // slight color variation
        const colors = ['#ffd1ff','#fff0d1','#ffd6a5','#e7d7ff','#ffffff'];
        s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.animationDelay = (Math.random()*200) + 'ms';
        document.body.appendChild(s);
        // remove after animation
        setTimeout(()=> s.remove(), 1200 + Math.random()*400);
      }
    }

    function newQuestion() {
      accepting = true;
      // √•terst√§ll flickans bild n√§r en ny fr√•ga visas
      showNormalGirl();
      feedbackEl.textContent = "";
      updateCounter();

      const num = Math.floor(Math.random()*9)+1;
      questionEl.textContent = `Vilken √§r tiokompisen till ${num}?`;

      const correct = 10 - num;
      const options = generateOptions(correct);

      buttonsEl.innerHTML = "";
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.className = "answer";
        btn.setAttribute("aria-label", `Svar ${opt}`);
        btn.addEventListener("click", () => handleAnswer(btn, opt, correct));
        buttonsEl.appendChild(btn);
      });
    }

    function generateOptions(correct) {
      const set = new Set([correct]);
      while(set.size<4){
        const wrong = Math.floor(Math.random()*9)+1;
        if(wrong!==correct) set.add(wrong);
      }
      return Array.from(set).sort(()=>Math.random()-0.5);
    }

    function handleAnswer(btn, answer, correct) {
      if(!accepting) return;
      accepting = false;
      Array.from(buttonsEl.children).forEach(b=>b.disabled=true);

      if(answer===correct){
        btn.classList.add("correct");
        feedbackEl.textContent = `‚úÖ R√§tt! ${answer} + ${10-answer} = 10 üéâ`;
        feedbackEl.style.color="lime";
        playSound(soundCorrect);
        score++;
        // Om detta var den sista po√§ngen: visa celebrate-bild och firande
        if(score>=maxPoang){
          showCelebrateGirl();
          celebrate();
        } else {
          // visa en 'good' bild kort innan n√§sta fr√•ga
          showGoodGirl();
          setTimeout(newQuestion, tidForNastaFraga);
        }
      } else {
        btn.classList.add("wrong");
        feedbackEl.textContent="‚ùå F√∂rs√∂k igen!";
        feedbackEl.style.color="salmon";
        playSound(soundWrong);
        // byt bild till en 'fel'-version
        showFalseGirl();
        setTimeout(()=>{
          btn.classList.remove("wrong");
          Array.from(buttonsEl.children).forEach(b=>b.disabled=false);
          // √•terst√§ll bild efter kort stund s√• spelaren ser normal bild igen
          showNormalGirl();
          accepting=true;
          feedbackEl.textContent="";
        },3000);
      }
    }

    function celebrate() {
      playSound(soundApplause);
      // visa celebrate-bilden under firandet (samma storlek som intro)
      showCelebrateGirl();
      buttonsEl.innerHTML="";
      questionEl.textContent="";
      feedbackEl.textContent="üåü Bra jobbat! Vi ses i morgon üåü";
      counterEl.textContent="";

      // skapa stj√§rnor som faller
      for(let i=0;i<20;i++){
        const star=document.createElement("div");
        star.className="star-fall";
        star.textContent="‚≠ê";
        star.style.left=Math.random()*90+"vw";
        star.style.animationDelay=(Math.random()*1.2)+"s";
        document.body.appendChild(star);
        star.addEventListener("animationend",()=>star.remove());
      }

      // reset-funktion: √•terg√• till intro, ta bort celebration-bild
      let didReset = false;
      function resetToIntro(){
        if(didReset) return; didReset = true;
        // ta bort event listeners
        try { soundApplause.removeEventListener('ended', resetToIntro); } catch(e){}
        try { girlGameCelebrate.removeEventListener('click', resetToIntro); } catch(e){}
        // ta bort eventuella kvarvarande stj√§rnor
        document.querySelectorAll('.star-fall').forEach(s=>s.remove());
        score=0;
        startScreen.style.display="flex";
        girlGame.style.display="none";
        // ta bort celebrate-klass och g√∂m bilden
        try { girlGameCelebrate.classList.remove('celebrate-visible'); } catch(e){}
        girlGameCelebrate.style.display = 'none';
        titleEl.style.display="none";
        feedbackEl.textContent="";
      }

      // l√•t anv√§ndaren klicka p√• celebrate-bilden f√∂r att √•terg√• direkt
      try { girlGameCelebrate.addEventListener('click', resetToIntro, {once:true}); } catch(e){}
      // h√•ll celebrate-bilden i 3 sekunder, sedan √•terg√• automatiskt
      setTimeout(resetToIntro, 3000);
    }

    startButton.addEventListener("click",()=>{
      // spela magic-ljud och visa magisk animation
      primeAudio();
      try { soundMagic.currentTime = 0; soundMagic.play().catch(()=>{}); } catch(e){}
      // pulsera intro-bilden kort
      const introImg = document.getElementById('introGirl');
      if (introImg) {
        introImg.classList.remove('intro-magic');
        void introImg.offsetWidth; // reflow
        introImg.classList.add('intro-magic');
      }
      // skapa gnistor (sparks)
      spawnSparks(10, introImg);

      // v√§nta p√• att magic-ljudet spelat klart innan vi g√•r vidare
      let movedOn = false;
      function proceedToGame(){
        if (movedOn) return; movedOn = true;
        startScreen.style.display="none";
        showNormalGirl();
        girlGame.style.display="block";
        titleEl.style.display="block";
        score=0;
        newQuestion();
      }
      try {
        // l√§gg p√• listener INNAN uppspelning s√• vi inte missar 'ended'
        soundMagic.addEventListener('ended', proceedToGame, {once:true});
      } catch(e){}
      // spela och v√§nta p√• promise; om play() avvisas kan vi inte v√§nta, d√• forts√§tter vi
      try {
        const p = soundMagic.play();
        if (p && typeof p.then === 'function') {
          p.catch(()=>{
            // om ljud inte kan spelas (autoplay-policy eller fel), forts√§tt √§nd√•
            proceedToGame();
          });
        }
      } catch(e){
        proceedToGame();
      }
    });

    girlGame.style.display="none";
    titleEl.style.display="none";
  </script>
</body>
</html>
